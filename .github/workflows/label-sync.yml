name: Sync Labels (ORG S)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.LABEL_SYNC_APP_ID }}
          private-key: ${{ secrets.LABEL_SYNC_PRIVATE_KEY }}
          owner: Achrobat

      - name: Sync labels to all repos (except blacklist)
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

          # === Configure these ===
          ORG: Achrobat
          SOURCE_REPO: Achrobat/Workflow-Repo

          # Comma-separated repo names (NOT nameWithOwner)
          # Example: "label-source-repo,do-not-touch,archived-repo"
          BLACKLIST: "Workflow-Repo"
        run: |
          set -euo pipefail

          echo "Fetching labels from source repo: $SOURCE_REPO"

          # Fetch ALL labels from the source repo (pagination handled by --paginate)
          src_labels=$(gh api -H "Accept: application/vnd.github+json" \
            "/repos/$SOURCE_REPO/labels?per_page=100" --paginate \
            | jq -s 'add')

          total=$(echo "$src_labels" | jq 'length')
          echo "Source labels found: $total"

          if [ "$total" -eq 0 ]; then
            echo "No labels found in source repo; aborting."
            exit 1
          fi

          # Build a lowercase set of source label names ONCE (used for default deletion guard)
          src_set=$(echo "$src_labels" | jq -r '.[].name | ascii_downcase' | sort -u)

          # Build blacklist set
          IFS=',' read -r -a bl <<< "${BLACKLIST}"
          is_blacklisted() {
            local name="$1"
            for x in "${bl[@]}"; do
              x="$(echo "$x" | sed 's/^ *//;s/ *$//')"
              if [ "$name" = "$x" ]; then
                return 0
              fi
            done
            return 1
          }

          echo "Listing repos in org: $ORG"

          # List repos in org (skip archived)
          repos=$(gh api -H "Accept: application/vnd.github+json" \
            "/orgs/$ORG/repos?per_page=100" --paginate \
            | jq -r '.[] | select(.archived == false) | .name')

          synced=0
          skipped=0

          for repo in $repos; do
            if is_blacklisted "$repo"; then
              echo "Skipping blacklisted repo: $ORG/$repo"
              skipped=$((skipped + 1))
              continue
            fi

            echo ""
            echo "== Syncing labels to $ORG/$repo =="

            # Fetch target labels once (used for both default deletion + case-insensitive update)
            tgt_json=$(gh api -H "Accept: application/vnd.github+json" \
              "/repos/$ORG/$repo/labels?per_page=100" --paginate)

            # TSV: "<lowercase>\t<actual>"
            tgt_map=$(echo "$tgt_json" | jq -r '.[] | [.name|ascii_downcase, .name] | @tsv')

            echo "  Deleting unwanted default labels (only if not present in source)..."

            # Defaults to remove (case-insensitive compare)
            DEFAULTS=("bug" "documentation" "duplicate" "enhancement" "good first issue" "help wanted" "invalid" "question" "wontfix")

            for def in "${DEFAULTS[@]}"; do
              def_lc=$(printf '%s' "$def" | tr '[:upper:]' '[:lower:]')

              # If the source repo already has this label name (case-insensitive), DO NOT delete it.
              if echo "$src_set" | grep -Fxq "$def_lc"; then
                echo "    keeping (in source): $def"
                continue
              fi

              # Find any target label(s) whose lowercase name matches this default and delete the actual name
              while IFS=$'\t' read -r lc actual; do
                [ "$lc" = "$def_lc" ] || continue
                enc_actual=$(printf '%s' "$actual" | jq -sRr @uri)
                if gh api -X DELETE -H "Accept: application/vnd.github+json" \
                  "/repos/$ORG/$repo/labels/$enc_actual" >/dev/null 2>&1; then
                  echo "    deleted: $actual"
                else
                  echo "    FAILED delete: $actual"
                fi
              done <<< "$tgt_map"
            done

            # Apply each source label to target repo (case-insensitive update to avoid Bug vs bug issues)
            echo "$src_labels" | jq -c '.[] | {name, color, description}' | while read -r label; do
              name=$(echo "$label" | jq -r '.name')
              color=$(echo "$label" | jq -r '.color')
              desc=$(echo "$label" | jq -r '.description // ""')

              name_lc=$(printf '%s' "$name" | tr '[:upper:]' '[:lower:]')

              # If target already has same label with different case, patch the existing one.
              existing="$(echo "$tgt_map" | awk -F'\t' -v k="$name_lc" '$1==k{print $2; exit}')"
              patch_name="${existing:-$name}"

              enc_patch=$(printf '%s' "$patch_name" | jq -sRr @uri)

              if gh api -X PATCH -H "Accept: application/vnd.github+json" \
                "/repos/$ORG/$repo/labels/$enc_patch" \
                -f new_name="$name" -f color="$color" -f description="$desc" >/dev/null 2>&1; then
                echo "  updated: $name"
              else
                if gh api -X POST -H "Accept: application/vnd.github+json" \
                  "/repos/$ORG/$repo/labels" \
                  -f name="$name" -f color="$color" -f description="$desc" >/dev/null 2>&1; then
                  echo "  created: $name"
                else
                  echo "  FAILED: $name"
                fi
              fi
            done

            synced=$((synced + 1))
          done

          echo ""
          echo "Done."
          echo "Repos synced:  $synced"
          echo "Repos skipped: $skipped"

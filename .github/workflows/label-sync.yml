name: Sync Labels

on:
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.LABEL_SYNC_APP_ID }}
          private-key: ${{ secrets.LABEL_SYNC_PRIVATE_KEY }}

      - name: Compute target repos (blacklist)
        id: repos
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          ORG: Achrobat
          BLACKLIST: "Test-Repo"
        run: |
          repos=$(gh repo list "$ORG" --limit 1000 --json nameWithOwner,isArchived \
            --jq '.[] | select(.isArchived == false) | .nameWithOwner')

          pattern=$(echo "$BLACKLIST" | tr ',' '|')
          targets=$(echo "$repos" | grep -Ev "$pattern" || true)

          {
            echo "targets<<EOF"
            echo "$targets"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Sync labels
        uses: EndBug/label-sync@v2
        with:
          token: ${{ steps.app-token.outputs.token }}
          source-repo: Achrobat/Test-Repo
          target-repos: ${{ steps.repos.outputs.targets }}
          delete-other-labels: false

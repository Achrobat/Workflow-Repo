name: Sync Labels (ORG S)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.LABEL_SYNC_APP_ID }}
          private-key: ${{ secrets.LABEL_SYNC_PRIVATE_KEY }}
          owner: Achrobat

      - name: Sync labels to all repos (except blacklist)
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

          # === Configure these ===
          ORG: Achrobat
          SOURCE_REPO: Achrobat/Workflow-Repo

          # Comma-separated repo names (NOT nameWithOwner)
          BLACKLIST: "Workflow-Repo"
        run: |
          set -euo pipefail

          echo "Fetching labels from source repo: $SOURCE_REPO"

          src_labels=$(gh api -H "Accept: application/vnd.github+json" \
            "/repos/$SOURCE_REPO/labels?per_page=100" --paginate \
            | jq -s 'add')

          total=$(echo "$src_labels" | jq 'length')
          echo "Source labels found: $total"

          if [ "$total" -eq 0 ]; then
            echo "No labels found in source repo; aborting."
            exit 1
          fi

          src_set=$(echo "$src_labels" | jq -r '.[].name | ascii_downcase' | sort -u)

          IFS=',' read -r -a bl <<< "${BLACKLIST}"
          is_blacklisted() {
            local name="$1"
            for x in "${bl[@]}"; do
              x="$(echo "$x" | sed 's/^ *//;s/ *$//')"
              if [ "$name" = "$x" ]; then
                return 0
              fi
            done
            return 1
          }

          echo "Listing repos in org: $ORG"

          repos=$(gh api -H "Accept: application/vnd.github+json" \
            "/orgs/$ORG/repos?per_page=100" --paginate \
            | jq -s 'add | .[] | select(.archived == false) | .name')

          synced=0
          skipped=0
          noaccess=0

          for repo in $repos; do
            if is_blacklisted "$repo"; then
              echo "Skipping blacklisted repo: $ORG/$repo"
              skipped=$((skipped + 1))
              continue
            fi

            echo ""
            echo "== Syncing labels to $ORG/$repo =="

            # ---- Guarded fetch: some repos will 404 if the App isn't installed / lacks access ----
            set +e
            tgt_raw=$(gh api -H "Accept: application/vnd.github+json" \
              "/repos/$ORG/$repo/labels?per_page=100" --paginate 2>&1)
            status=$?
            set -e

            if [ $status -ne 0 ]; then
              # Typically "gh: Not Found (HTTP 404)" for no access
              echo "  Skipping (no access or not found): $tgt_raw"
              noaccess=$((noaccess + 1))
              continue
            fi

            tgt_json=$(printf '%s' "$tgt_raw" | jq -s 'add')
            tgt_map=$(echo "$tgt_json" | jq -r '.[] | [.name|ascii_downcase, .name] | @tsv')

            echo "  Deleting unwanted default labels (only if not present in source)..."

            DEFAULTS=("bug" "documentation" "duplicate" "enhancement" "good first issue" "help wanted" "invalid" "question" "wontfix")

            for def in "${DEFAULTS[@]}"; do
              def_lc=$(printf '%s' "$def" | tr '[:upper:]' '[:lower:]')

              if echo "$src_set" | grep -Fxq "$def_lc"; then
                echo "    keeping (in source): $def"
                continue
              fi

              while IFS=$'\t' read -r lc actual; do
                [ "$lc" = "$def_lc" ] || continue
                enc_actual=$(printf '%s' "$actual" | jq -sRr @uri)
                if gh api -X DELETE -H "Accept: application/vnd.github+json" \
                  "/repos/$ORG/$repo/labels/$enc_actual" >/dev/null 2>&1; then
                  echo "    deleted: $actual"
                else
                  echo "    FAILED delete: $actual"
                fi
              done <<< "$tgt_map"
            done

            echo "$src_labels" | jq -c '.[] | {name, color, description}' | while read -r label; do
              name=$(echo "$label" | jq -r '.name')
              color=$(echo "$label" | jq -r '.color')
              desc=$(echo "$label" | jq -r '.description // ""')

              name_lc=$(printf '%s' "$name" | tr '[:upper:]' '[:lower:]')
              existing="$(echo "$tgt_map" | awk -F'\t' -v k="$name_lc" '$1==k{print $2; exit}')"
              patch_name="${existing:-$name}"

              enc_patch=$(printf '%s' "$patch_name" | jq -sRr @uri)

              if gh api -X PATCH -H "Accept: application/vnd.github+json" \
                "/repos/$ORG/$repo/labels/$enc_patch" \
                -f new_name="$name" -f color="$color" -f description="$desc" >/dev/null 2>&1; then
                echo "  updated: $name"
              else
                if gh api -X POST -H "Accept: application/vnd.github+json" \
                  "/repos/$ORG/$repo/labels" \
                  -f name="$name" -f color="$color" -f description="$desc" >/dev/null 2>&1; then
                  echo "  created: $name"
                else
                  echo "  FAILED: $name"
                fi
              fi
            done

            synced=$((synced + 1))
          done

          echo ""
          echo "Done."
          echo "Repos synced:   $synced"
          echo "Repos skipped:  $skipped"
          echo "No access/404:  $noaccess"
